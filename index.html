<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nails Finder</title>
  <link rel="stylesheet" href="./assets/styles.css"/>
  <style>
    .hidden { display: none !important; }
    .back-btn {
      margin-top: 1rem;
      padding: .55rem .85rem;
      border-radius: .6rem;
      border: 1px solid transparent;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .card { cursor: pointer; }
    .btn-contratar {
      margin-top: 1rem;
      padding: .6rem 1.2rem;
      border-radius: .6rem;
      border: none;
      background: var(--accent);
      color: white;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-instagram {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      margin-top: 1rem;
      padding: .55rem 1rem;
      border-radius: .6rem;
      background: linear-gradient(135deg, #f58529, #dd2a7b, #8134af);
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      width: fit-content;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .btn-instagram:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(129, 52, 175, 0.35);
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      z-index: 1000;
    }
    .modal-dialog {
      width: min(600px, 100%);
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }
    .modal-form {
      display: grid;
      gap: 1rem;
    }
    .modal-form label {
      display: block;
      font-weight: 600;
      margin-bottom: .35rem;
    }
    .modal-form input,
    .modal-form select,
    .modal-form textarea {
      width: 100%;
      padding: .65rem .75rem;
      border-radius: .55rem;
      border: 1px solid #d0d0d0;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
    }
    .modal-actions {
      display: flex;
      gap: .75rem;
      justify-content: flex-end;
      margin-top: .5rem;
    }
    .btn-secondary {
      padding: .6rem 1.2rem;
      border-radius: .6rem;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrapper nav">
      <a class="brand" href="#">
        <span class="dot"></span>
        <span>Nails Finder</span>
      </a>
      <nav class="menu" aria-label="principal">
        <a href="#">Inicio</a>
        <a href="#">Contacto</a>
      </nav>
      <form class="search" role="search" aria-label="Buscar emprendimientos" onsubmit="event.preventDefault()">
        <input type="search" placeholder="Buscar..." aria-label="Buscar"/>
      </form>
    </div>
  </header>

  <!-- Main -->
  <main class="wrapper">
    <!-- Vista listado -->
    <section id="vista-listado">
      <h2 class="section-title">Emprendimientos destacados</h2>
      <div class="grid" id="grid-profesionales"></div>
    </section>

    <!-- Vista detalle -->
    <section id="vista-detalle" class="hidden">
      <button class="back-btn" onclick="volverListado()">‚Üê Volver</button>
      <h2 id="prof-name" class="section-title"></h2>
      <div id="prof-info" class="content"></div>

      <button id="btn-contratar" class="btn-contratar" type="button">Contratar ahora</button>

      <h3 class="section-title">Servicios</h3>
      <div class="grid" id="prof-servicios"></div>

      <h3 class="section-title">Trabajos realizados</h3>
      <div class="grid" id="prof-trabajos"></div>
    </section>

    <div id="modal-contratar" class="modal-overlay hidden" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-header">
          <h3 id="modal-title">Agendar cita</h3>
          <button type="button" class="modal-close" aria-label="Cerrar modal">&times;</button>
        </div>
        <form id="form-contratar" class="modal-form">
          <input type="hidden" name="profesional_id" id="modal-profesional-id"/>
          <div>
            <label for="modal-cliente-id">ID de cliente</label>
            <input type="text" id="modal-cliente-id" name="cliente_id" required/>
          </div>
          <div>
            <label for="modal-servicio-id">Servicio</label>
            <select id="modal-servicio-id" name="servicio_id" required>
              <option value="">Selecciona un servicio</option>
            </select>
          </div>
          <div>
            <label for="modal-fecha">Fecha y hora</label>
            <input type="datetime-local" id="modal-fecha" name="fecha" required/>
          </div>
          <div>
            <label for="modal-estado">Estado</label>
            <select id="modal-estado" name="estado" required>
              <option value="pendiente">Pendiente</option>
              <option value="confirmada">Confirmada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <div>
            <label for="modal-notas">Notas</label>
            <textarea id="modal-notas" name="notas" rows="3" placeholder="Detalles adicionales"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" data-modal-cancel>Cancelar</button>
            <button type="submit" class="btn-contratar">Guardar reserva</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="wrapper footer-grid">
      <div>¬© <span id="yy"></span> Nails Finder ‚Äî Todos los derechos reservados.</div>
      <div class="links">
        <a href="#">Sobre nosotros</a>
        <a href="#">Privacidad</a>
        <a href="#">T√©rminos</a>
        <a href="#">Instagram</a>
        <a href="#">Facebook</a>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('yy').textContent = new Date().getFullYear();

    const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxhd3RrcmFzZmxwaHZjd3hkbmx3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MzY2NDAsImV4cCI6MjA3MzIxMjY0MH0.A18gO8TBTctb-KcN3Nf8n7dEIXQ_WtwuIr5bKUTUizs"; // üëà pega aqu√≠ tu JWT v√°lido
    const CLIENTE_ID = "0825d76a-7fd8-44ef-a9ed-b67a85e6721e";

    const modalOverlay = document.getElementById("modal-contratar");
    const modalForm = document.getElementById("form-contratar");
    const modalServiceSelect = document.getElementById("modal-servicio-id");
    const modalProfesionalInput = document.getElementById("modal-profesional-id");
    const modalClienteInput = document.getElementById("modal-cliente-id");
    const modalCloseBtn = modalOverlay.querySelector(".modal-close");
    const modalCancelBtn = modalOverlay.querySelector("[data-modal-cancel]");
    const contratarAhoraBtn = document.getElementById("btn-contratar");
    const modalTitle = document.getElementById("modal-title");
    const body = document.body;

    let profesionalActual = null;

    modalClienteInput.value = CLIENTE_ID;

    function abrirModal() {
      if (!profesionalActual) return;
      modalOverlay.classList.remove("hidden");
      modalOverlay.setAttribute("aria-hidden", "false");
      body.style.overflow = "hidden";
      modalProfesionalInput.value = profesionalActual.id;
      modalTitle.textContent = `Agendar cita con ${profesionalActual.usuarios.nombre}`;
    }

    function cerrarModal() {
      modalOverlay.classList.add("hidden");
      modalOverlay.setAttribute("aria-hidden", "true");
      body.style.overflow = "";
      modalForm.reset();
      modalClienteInput.value = CLIENTE_ID;
      modalServiceSelect.innerHTML = '<option value="">Selecciona un servicio</option>';
      if (profesionalActual) {
        poblarServicios(profesionalActual);
        modalProfesionalInput.value = profesionalActual.id;
        modalTitle.textContent = `Agendar cita con ${profesionalActual.usuarios.nombre}`;
      }
    }

    function poblarServicios(profesional) {
      modalServiceSelect.innerHTML = '<option value="">Selecciona un servicio</option>';
      (profesional.profesional_servicios || []).forEach(rel => {
        const option = document.createElement("option");
        option.value = rel.servicios.id;
        option.textContent = `${rel.servicios.nombre} - Q${rel.servicios.precio}`;
        modalServiceSelect.appendChild(option);
      });
    }

    contratarAhoraBtn.addEventListener("click", abrirModal);
    modalCloseBtn.addEventListener("click", cerrarModal);
    modalCancelBtn.addEventListener("click", cerrarModal);
    modalOverlay.addEventListener("click", (event) => {
      if (event.target === modalOverlay) {
        cerrarModal();
      }
    });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && !modalOverlay.classList.contains("hidden")) {
        cerrarModal();
      }
    });

    modalForm.addEventListener("submit", async (event) => {
      event.preventDefault();

      if (!profesionalActual) {
        alert("Selecciona un profesional antes de crear una reserva.");
        return;
      }

      const formData = new FormData(modalForm);
      const fechaRaw = formData.get("fecha");
      if (!fechaRaw) {
        alert("Ingresa una fecha y hora v√°lidas.");
        return;
      }

      const payload = {
        cliente_id: formData.get("cliente_id"),
        profesional_id: formData.get("profesional_id"),
        servicio_id: formData.get("servicio_id"),
        fecha: new Date(fechaRaw).toISOString(),
        estado: formData.get("estado"),
        notas: formData.get("notas") || ""
      };

      if (!payload.servicio_id) {
        alert("Selecciona el servicio que deseas reservar.");
        return;
      }

      try {
        const response = await fetch("https://lawtkrasflphvcwxdnlw.supabase.co/functions/v1/reservas", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${TOKEN}`
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorBody = await response.json().catch(() => ({}));
          const message = errorBody.message || "No se pudo crear la reserva.";
          throw new Error(message);
        }

        alert("Reserva creada con √©xito. ¬°Te contactaremos pronto!");
        cerrarModal();
      } catch (error) {
        console.error(error);
        alert(error.message || "Ocurri√≥ un error al crear la reserva. Intenta nuevamente.");
      }
    });

    // üîπ Endpoint 1: cargar todos los profesionales
    async function cargarProfesionales() {
      const grid = document.getElementById("grid-profesionales");
      const imagenes = [
        "/public/static/images/unÃÉas3.jpg",
        "/public/static/images/imagen de unÃÉas.jpg",
        "/public/static/images/unÃÉas2.png"
      ];

      try {
        const resp = await fetch("https://lawtkrasflphvcwxdnlw.supabase.co/functions/v1/profesionales", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${TOKEN}`
          }
        });

        if (!resp.ok) throw new Error("Error al obtener profesionales");

        const { profesionales } = await resp.json();
        grid.innerHTML = "";

        profesionales.forEach((prof) => {
          const imgRandom = imagenes[Math.floor(Math.random() * imagenes.length)];

          const card = document.createElement("article");
          card.className = "card";
          card.innerHTML = `
            <div class="thumb">
              <img src="${imgRandom}" alt="">
            </div>
            <div class="content">
              <h3 class="title">${prof.usuarios.nombre} ${prof.usuarios.apellido}</h3>
              <p class="desc">${prof.descripcion}</p>
              <p class="desc">üíº <strong>Experiencia:</strong> ${prof.experiencia} a√±os</p>
              <p class="desc">‚≠ê <strong>Calificaci√≥n:</strong> ${prof.calificacion_promedio}</p>
              <button class="btn" type="button">Contratar</button>
            </div>
          `;

          card.addEventListener("click", () => verDetalle(prof.id));
          card.querySelector(".btn").addEventListener("click", (e) => {
            e.stopPropagation();
            verDetalle(prof.id);
          });

          grid.appendChild(card);
        });

      } catch (err) {
        console.error(err);
        grid.innerHTML = "<p>No se pudieron cargar los profesionales.</p>";
      }
    }

    async function verDetalle(id) {
      document.getElementById("vista-listado").classList.add("hidden");
      document.getElementById("vista-detalle").classList.remove("hidden");

      const resp = await fetch(`https://lawtkrasflphvcwxdnlw.supabase.co/functions/v1/Informaci-n-desplegada?id=${id}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${TOKEN}`
        }
      });

      const { profesional, trabajos } = await resp.json();

      if (!profesional) {
        document.getElementById("prof-name").textContent = "Profesional no encontrado";
        return;
      }

      document.getElementById("prof-name").textContent =
        "üíÖ " + profesional.usuarios.nombre + " " + profesional.usuarios.apellido;

      document.getElementById("prof-info").innerHTML = `
        <p>üíº <strong>Experiencia:</strong> ${profesional.experiencia} a√±os</p>
        <p>‚≠ê <strong>Calificaci√≥n:</strong> ${profesional.calificacion_promedio}</p>
        <p>üìç <strong>Direcci√≥n:</strong> ${profesional.direccion}</p>
        <p>üìû <strong>Tel√©fono:</strong> ${profesional.usuarios.telefono}</p>
        <p>üìß <strong>Email:</strong> ${profesional.usuarios.email}</p>
        <p>${profesional.descripcion}</p>
        <a class="btn-instagram" href="https://www.instagram.com/anny_nails_studio_?igsh=OXcwazJsenVxMDRs" target="_blank" rel="noopener noreferrer">
          <span aria-hidden="true">üì∏</span>
          Visitar Instagram
        </a>
      `;

      // Servicios
      const serviciosGrid = document.getElementById("prof-servicios");
      serviciosGrid.innerHTML = "";
      (profesional.profesional_servicios || []).forEach(rel => {
        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          <div class="content">
            <h3 class="title">üíÖ ${rel.servicios.nombre}</h3>
            <p class="desc">${rel.servicios.descripcion}</p>
            <p class="desc">‚è±Ô∏è ${rel.servicios.duracion_minutos} min</p>
            <p class="desc">üíµ Q${rel.servicios.precio}</p>
          </div>
        `;
        serviciosGrid.appendChild(card);
      });

      const trabajosGrid = document.getElementById("prof-trabajos");
      trabajosGrid.innerHTML = "";
      trabajos.forEach(t => {
        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb"><img src="${t.url}" alt="${t.descripcion}"></div>
          <div class="content"><p class="desc">üé® ${t.descripcion ?? "Trabajo realizado"}</p></div>
        `;
        trabajosGrid.appendChild(card);
      });

      profesionalActual = profesional;
      modalProfesionalInput.value = profesional.id;
      modalTitle.textContent = `Agendar cita con ${profesional.usuarios.nombre}`;
      poblarServicios(profesional);
    }

    function volverListado() {
      document.getElementById("vista-detalle").classList.add("hidden");
      document.getElementById("vista-listado").classList.remove("hidden");
    }

    cargarProfesionales();
  </script>
</body>
</html>
